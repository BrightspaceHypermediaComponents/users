<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-fetch-siren-entity-behavior/d2l-fetch-siren-entity-behavior.html">

<link rel="import" href="./d2l-profile-image.html">

<!--
`d2l-profile-image-hm`
D2L Profile Image Hypermedia
@demo demo/index_hm.html
-->

<dom-module id="d2l-profile-image-hm">
	<template strip-whitespace>
			<style include="d2l-profile-image-shared-styles">
			</style>
			<d2l-profile-image
				id="d2l-profile-image"
				small$="[[small]]"
				medium$="[[medium]]"
				large$="[[large]]"
				x-large$="[[xLarge]]"
				first-name="[[_firstName]]"
				last-name="[[_lastName]]"
				colour-id="[[_colourId]]"
				image-url="[[_imageUrl]]">
			</d2l-profile-image>
	</template>
	<script>
		Polymer({
			is: 'd2l-profile-image-hm',
			properties: {
				href: {
					type: String,
					observer: '_configureProfileImage'
				},
				small: {
					type: Boolean
				},
				medium: {
					type: Boolean
				},
				large: {
					type: Boolean
				},
				xLarge: {
					type: Boolean
				},
				_firstName: {
					type: String,
					value: ''
				},
				_lastName: {
					type: String,
					value: ''
				},
				_colourId: {
					type: Number,
					value: -1
				},
				_imageUrl: {
					type: String,
					value: ''
				}
			},
			behaviors: [
				D2L.PolymerBehaviors.FetchSirenEntityBehavior
			],
			_configureProfileImage: function() {
				this._fetchUserInformation()
					.then(function() {
						this._configureProfileImageSize();
					}.bind(this));
			},
			_fetchUserInformation: function() {
				return this._fetchEntity(this.href)
					.then(function(data) {
						if (data.hasSubEntityByRel('https://api.brightspace.com/rels/user-profile')) {
							var userProfile = data.getSubEntityByRel('https://api.brightspace.com/rels/user-profile');
							var profileImage = userProfile.getSubEntityByRel('https://api.brightspace.com/rels/profile-image');

							if (!profileImage.hasClass('default-image')) {
								var imageEntity = profileImage.getLinkByRel('https://api.brightspace.com/rels/thumbnail#small');
								this.set('_imageUrl', imageEntity.href);
							}
							else{
								this.set('_imageUrl', '');
							}
						}

						var firstName = data.getSubEntityByRel('https://api.brightspace.com/rels/first-name');
						if (!firstName.hasClass('default-name')) {
							this.set('_firstName', firstName.properties.name);
						}
						else {
							this.set('_firstName', '');
						}

						var lastName = data.getSubEntityByRel('https://api.brightspace.com/rels/last-name');
						if (!lastName.hasClass('default-name')) {
							this.set('_lastName', lastName.properties.name);
						}
						else {
							this.set('_lastName', '');
						}

						var selfLink = data.getLinkByRel('self').href;
						var userId = selfLink.split('/').pop();
						if (!isNaN(userId)) {
							this.set('_colourId', userId);
						}
						else {
							this.set('_colourId', -1);
						}
					}.bind(this))
					.catch(function() {
						// Do nothing
					});
			}
		});
	</script>
</dom-module>